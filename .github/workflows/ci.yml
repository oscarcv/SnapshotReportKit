name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'push' }}

jobs:
  build-and-test:
    runs-on: macos-15
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "latest-stable"

      - name: Show toolchain
        run: |
          xcodebuild -version
          swift --version

      - name: Resolve dependencies
        run: swift package resolve

      - name: Build
        run: swift build --build-tests

      - name: Run tests
        run: |
          set -euo pipefail
          LOG_FILE="$(mktemp -t swift-test-log.XXXXXX.log)"
          echo "Running swift test (logs: ${LOG_FILE})"

          swift test --verbose >"${LOG_FILE}" 2>&1 &
          TEST_PID=$!
          START_TS=$(date +%s)
          TIMEOUT_SECONDS=$((20 * 60))

          while kill -0 "${TEST_PID}" 2>/dev/null; do
            NOW_TS=$(date +%s)
            ELAPSED=$((NOW_TS - START_TS))
            echo "[ci] swift test still running (${ELAPSED}s elapsed)"
            ps -p "${TEST_PID}" -o pid=,ppid=,%cpu=,%mem=,etime=,command= || true
            echo "===== swift test log (tail -n 40) ====="
            tail -n 40 "${LOG_FILE}" || true

            if [ "${ELAPSED}" -ge "${TIMEOUT_SECONDS}" ]; then
              echo "[ci] ERROR: swift test exceeded timeout (${TIMEOUT_SECONDS}s)"
              kill -TERM "${TEST_PID}" 2>/dev/null || true
              sleep 5
              kill -KILL "${TEST_PID}" 2>/dev/null || true
              echo "===== swift test log (tail) ====="
              tail -n 200 "${LOG_FILE}" || true
              exit 124
            fi

            sleep 30
          done

          set +e
          wait "${TEST_PID}"
          STATUS=$?
          set -e
          echo "===== swift test log (tail) ====="
          tail -n 200 "${LOG_FILE}" || true
          exit "${STATUS}"

      - name: CLI smoke test
        run: swift run snapshot-report --help
