<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{{ report.name }}</title>
  <style>
    :root {
      --primary: #137fec;
      --bg: #101922;
      --surface: #17222d;
      --surface-soft: #1e2c3d;
      --border: #2a3b4d;
      --text: #f1f5f9;
      --muted: #92adc9;
      --success: #238636;
      --danger: #da3633;
      --warning: #d29922;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .layout {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 300px 1fr;
    }

    .sidebar {
      border-right: 1px solid var(--border);
      background: #0e171f;
      padding: 1rem;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow: auto;
    }

    :focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    .title { font-size: 1.05rem; font-weight: 700; margin: 0 0 0.25rem; }
    .muted { color: var(--muted); }

    .suite-link {
      display: block;
      text-decoration: none;
      color: #d3deea;
      padding: 0.55rem 0.65rem;
      border: 1px solid transparent;
      border-radius: 10px;
      margin-bottom: 0.4rem;
      background: transparent;
    }

    .suite-link:hover { background: var(--surface); border-color: var(--border); }

    .count {
      float: right;
      background: #223344;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.05rem 0.45rem;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .content { padding: 1.5rem; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      position: sticky;
      top: 0;
      z-index: 10;
      padding: 0.6rem 0;
      background: linear-gradient(180deg, rgba(16,25,34,0.98), rgba(16,25,34,0.86));
      backdrop-filter: blur(4px);
    }

    .topbar h1 { margin: 0; font-size: 1.6rem; }
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem;
      align-items: center;
    }

    .toolbar input[type="search"] {
      min-width: 260px;
      max-width: 520px;
      width: min(52vw, 520px);
      background: #0f1821;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.45rem 0.65rem;
      font-size: 0.85rem;
    }

    .toolbar button {
      background: #0f1821;
      color: #d3deea;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.42rem 0.62rem;
      font-size: 0.78rem;
      cursor: pointer;
    }

    .toolbar button.active {
      background: rgba(19, 127, 236, 0.18);
      border-color: var(--primary);
      color: #cfe7ff;
    }

    .toolbar button:hover { border-color: #44607c; }
    .toolbar-help {
      color: var(--muted);
      font-size: 0.72rem;
      margin-left: 0.35rem;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(5, minmax(120px, 1fr));
      gap: 0.8rem;
      margin-bottom: 1rem;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 0.85rem;
    }

    .card .label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 0.2rem;
    }

    .card strong { font-size: 1.35rem; }

    .suite {
      margin-top: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: var(--surface);
    }

    .suite-header {
      padding: 0.8rem 1rem;
      background: var(--surface-soft);
      border-bottom: 1px solid var(--border);
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
    }

    .suite-actions {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      font-weight: 500;
      color: var(--muted);
      font-size: 0.76rem;
    }

    .suite-toggle {
      border: 1px solid var(--border);
      background: #101c28;
      color: #d3deea;
      border-radius: 6px;
      font-size: 0.74rem;
      padding: 0.24rem 0.48rem;
      cursor: pointer;
    }

    .suite-collapsed .suite-table-wrap {
      display: none;
    }

    .suite-count-chip {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 0.05rem 0.42rem;
      color: #bfd2e7;
      background: #132233;
    }

    .hidden-row {
      display: none;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.65rem 0.7rem;
      border-bottom: 1px solid var(--border);
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.72rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: #111b24;
    }

    .badge {
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: 700;
      border: 1px solid transparent;
      display: inline-block;
    }

    .passed { color: #57d68d; background: rgba(35, 134, 54, 0.15); border-color: rgba(35, 134, 54, 0.35); }
    .failed { color: #ff8d8a; background: rgba(218, 54, 51, 0.18); border-color: rgba(218, 54, 51, 0.35); }
    .skipped { color: #ffd884; background: rgba(210, 153, 34, 0.18); border-color: rgba(210, 153, 34, 0.35); }

    .mono { font-family: "JetBrains Mono", "SFMono-Regular", monospace; font-size: 0.82rem; color: #cdd9e5; }

    .failure {
      margin-top: 0.45rem;
      background: rgba(218, 54, 51, 0.14);
      border: 1px solid rgba(218, 54, 51, 0.25);
      border-radius: 8px;
      padding: 0.5rem;
      color: #ffd4d2;
      white-space: pre-wrap;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      font-size: 0.8rem;
    }

    .attachments {
      margin-top: 0.5rem;
      display: grid;
      gap: 0.5rem;
    }

    .attachments.passed-variants,
    .attachments.failed-variants {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      gap: 0.65rem;
      align-items: stretch;
    }

    .attachment {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #111b24;
      padding: 0.5rem;
    }

    .attachments.passed-variants .attachment,
    .attachments.failed-variants .attachment {
      min-width: 240px;
      flex: 1 1 clamp(240px, 28vw, 420px);
    }

    .details-cell {
      background: #0f1821;
      border-top: none;
      padding-top: 0.25rem;
      padding-bottom: 0.8rem;
    }

    details.failure-details {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0e171f;
      padding: 0.5rem;
    }

    details.failure-details > summary {
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--muted);
      user-select: none;
      list-style: none;
    }

    details.failure-details > summary::-webkit-details-marker { display: none; }

    .failed-assert-grid {
      display: grid;
      gap: 0.65rem;
      margin-top: 0.65rem;
    }

    .assert-group {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #0f1821;
      padding: 0.5rem;
    }

    .assert-group-title {
      font-size: 0.76rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.45rem;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
    }

    .failed-assert-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(230px, 1fr));
      gap: 0.65rem;
    }

    .failed-slot {
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #111b24;
      padding: 0.5rem;
      min-height: 90px;
    }

    .failed-slot.empty {
      opacity: 0.45;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--muted);
      font-size: 0.78rem;
    }

    .attachment .name {
      color: var(--muted);
      text-transform: uppercase;
      font-size: 0.68rem;
      letter-spacing: 0.06em;
      margin-bottom: 0.35rem;
    }

    .attachment img {
      width: 100%;
      max-width: 320px;
      height: auto;
      object-fit: contain;
      border-radius: 7px;
      border: 1px solid var(--border);
      display: block;
      margin: 0 auto;
    }

    .failed-slot img {
      width: 100%;
      max-width: 320px;
      height: auto;
      object-fit: contain;
      border-radius: 7px;
      border: 1px solid var(--border);
      display: block;
      margin: 0 auto;
    }

    .attachment pre {
      margin: 0;
      white-space: pre-wrap;
      max-height: 180px;
      overflow: auto;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      font-size: 0.76rem;
      color: #d3deea;
    }

    .attachment a { color: #7ab8ff; text-decoration: none; }
    .attachment-meta {
      margin-top: 0.35rem;
      font-size: 0.7rem;
      color: var(--muted);
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      word-break: break-all;
    }

    .attachment-empty {
      border: 1px dashed var(--border);
      border-radius: 8px;
      padding: 0.65rem;
      color: var(--muted);
      font-size: 0.78rem;
      text-align: center;
      background: #0e171f;
    }

    .reference-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin-top: 0.4rem;
      padding: 0.25rem 0.65rem;
      border: 1px solid var(--primary);
      border-radius: 6px;
      color: var(--primary);
      font-size: 0.78rem;
      font-weight: 600;
      text-decoration: none;
    }
    .reference-btn:hover { background: rgba(19, 127, 236, 0.12); }

    @media (max-width: 1080px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { height: auto; position: static; }
      .summary { grid-template-columns: repeat(2, minmax(120px, 1fr)); }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <h2 class="title">Test Explorer</h2>
      <div class="muted" style="font-size: 0.8rem; margin-bottom: 0.9rem;">Generated: {{ report.generatedAt }}</div>
      {% for suite in suites %}
        <a class="suite-link" href="#suite-{{ forloop.counter }}">
          {{ suite.name }}
          <span class="count">{{ suite.tests.count }}</span>
        </a>
      {% endfor %}
    </aside>

    <main class="content">
      <section class="topbar">
        <div>
          <h1>{{ report.name }}</h1>
          <div class="muted">Snapshot QA Dashboard</div>
        </div>
        <div class="toolbar">
          <label class="sr-only" for="searchInput">Search tests</label>
          <input id="searchInput" type="search" placeholder="Search test title..." />
          <button type="button" class="filter-btn active" data-filter="all">All</button>
          <button type="button" class="filter-btn" data-filter="failed">Failed</button>
          <button type="button" class="filter-btn" data-filter="passed">Passed</button>
          <button type="button" class="filter-btn" data-filter="skipped">Skipped</button>
          <button type="button" class="variant-btn active" data-variant="hcdark">High Contrast Dark</button>
          <button type="button" class="variant-btn active" data-variant="dark">Dark</button>
          <button type="button" class="variant-btn active" data-variant="hclight">High Contrast Light</button>
          <button type="button" class="variant-btn active" data-variant="light">Light</button>
          <button type="button" id="failedFirstBtn">Failed First: Off</button>
          <button type="button" id="expandAllBtn">Expand All</button>
          <button type="button" id="collapseAllBtn">Collapse Passed Suites</button>
          <span class="toolbar-help" aria-hidden="true">Shortcuts: / search, f failed, e expand/collapse</span>
        </div>
      </section>

      <section class="summary">
        <div class="card"><div class="label">Total Tests</div><strong>{{ report.summary.total }}</strong></div>
        <div class="card"><div class="label">Passed</div><strong style="color:#57d68d;">{{ report.summary.passed }}</strong></div>
        <div class="card"><div class="label">Failed</div><strong style="color:#ff8d8a;">{{ report.summary.failed }}</strong></div>
        <div class="card"><div class="label">Skipped</div><strong style="color:#ffd884;">{{ report.summary.skipped }}</strong></div>
        <div class="card"><div class="label">Duration</div><strong>{{ report.summary.duration }}s</strong></div>
      </section>

      {% for suite in suites %}
        <section id="suite-{{ forloop.counter }}" class="suite" data-suite-name="{{ suite.name|lowercase }}">
          <div class="suite-header">
            <span>{{ suite.name }}</span>
            <span class="suite-actions">
              <span class="suite-count-chip">{{ suite.tests.count }} tests</span>
              <button type="button" class="suite-toggle" data-suite-toggle>Collapse</button>
            </span>
          </div>
          <div class="suite-table-wrap">
          <table>
            <thead>
              <tr>
                <th>Status</th>
                <th>Test Name</th>
                <th>Class</th>
              </tr>
            </thead>
            <tbody>
              {% for test in suite.tests %}
                <tr class="test-row" data-status="{{ test.status }}" data-suite="{{ suite.name|lowercase }}" data-test="{{ test.name|lowercase }}" data-title="{{ test.name|lowercase }}" data-class="{{ test.className|lowercase }}" data-key="suite{{ forloop.parentloop.counter }}-test{{ forloop.counter }}">
                  <td>
                    <span class="badge {{ test.status }}">{{ test.status }}</span>
                  </td>
                  <td class="mono">{{ test.name }}</td>
                  <td>{{ test.className }}</td>
                </tr>
                {% if test.status == "failed" %}
                  <tr class="detail-row" data-parent="suite{{ forloop.parentloop.counter }}-test{{ forloop.counter }}">
                    <td class="details-cell" colspan="3">
                      <details class="failure-details">
                        <summary>Details</summary>
                        {% if test.referenceURL != "" %}
                          <a class="reference-btn" href="{{ test.referenceURL }}" target="_blank" rel="noopener">&#128279; View Reference</a>
                        {% endif %}
                        <div class="failure">{{ test.failure.message }}{% if test.failure.file != "" %}

File: {{ test.failure.file }}{% if test.failure.line != "" %}:{{ test.failure.line }}{% endif %}{% endif %}{% if test.failure.diff != "" %}

{{ test.failure.diff }}{% endif %}</div>

                        {% if test.failedGroups.count > 0 %}
                          <div class="failed-assert-grid">
                            {% for group in test.failedGroups %}
                              <div class="assert-group">
                                <div class="assert-group-title">{{ group.groupName }}</div>
                                <div class="failed-assert-row">
                                  {% if group.snapshot.exists and group.snapshot.isEmpty == false %}
                                    <div class="failed-slot">
                                      <div class="name">Snapshot</div>
                                      <img src="{{ group.snapshot.path }}" alt="Snapshot" />
                                    </div>
                                  {% else %}
                                    <div class="failed-slot empty">Snapshot unavailable{% if group.snapshot.exists and group.snapshot.isEmpty %} (empty file){% endif %}</div>
                                  {% endif %}

                                  {% if group.diff.exists and group.diff.isEmpty == false %}
                                    <div class="failed-slot">
                                      <div class="name">Diff</div>
                                      <img src="{{ group.diff.path }}" alt="Diff" />
                                    </div>
                                  {% else %}
                                    <div class="failed-slot empty">Diff unavailable{% if group.diff.exists and group.diff.isEmpty %} (empty file){% endif %}</div>
                                  {% endif %}

                                  {% if group.failure.exists and group.failure.isEmpty == false %}
                                    <div class="failed-slot">
                                      <div class="name">Failure</div>
                                      <img src="{{ group.failure.path }}" alt="Failure" />
                                    </div>
                                  {% else %}
                                    <div class="failed-slot empty">Failure unavailable{% if group.failure.exists and group.failure.isEmpty %} (empty file){% endif %}</div>
                                  {% endif %}
                                </div>
                              </div>
                            {% endfor %}
                          </div>
                        {% endif %}
                      </details>
                    </td>
                  </tr>
                {% endif %}

                {% if test.status == "passed" and test.passedGroups.count > 0 %}
                  <tr class="detail-row" data-parent="suite{{ forloop.parentloop.counter }}-test{{ forloop.counter }}">
                    <td class="details-cell" colspan="3">
                      <div class="failed-assert-grid">
                        {% for group in test.passedGroups %}
                          <div class="assert-group">
                            <div class="assert-group-title">{{ group.groupName }}</div>
                            <div class="attachments passed-variants">
                              {% for attachment in group.attachments %}
                                <div class="attachment" style="order: {{ attachment.variantOrder }};">
                                  <div class="name">{{ attachment.name }} ({{ attachment.type }})</div>
                                  {% if attachment.exists == false %}
                                    <div class="attachment-empty">Attachment missing on disk</div>
                                  {% elif attachment.isEmpty %}
                                    <div class="attachment-empty">Attachment exists but file is empty</div>
                                  {% elif attachment.type == "png" %}
                                    <img src="{{ attachment.path }}" alt="{{ attachment.name }}" />
                                  {% elif attachment.type == "dump" or attachment.type == "text" %}
                                    <pre>{% if attachment.content != "" %}{{ attachment.content }}{% else %}Attachment file path: {{ attachment.path }}{% endif %}</pre>
                                  {% else %}
                                    <a href="{{ attachment.path }}">Download attachment</a>
                                  {% endif %}
                                  <div class="attachment-meta">
                                    size={{ attachment.sizeBytes }} bytes
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          </div>
                        {% endfor %}
                      </div>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>
          </table>
          </div>
        </section>
      {% endfor %}
    </main>
  </div>
  <script>
    (() => {
      const storageKey = "snapshot-report-ui-v1";
      const searchInput = document.getElementById("searchInput");
      const filterButtons = Array.from(document.querySelectorAll(".filter-btn"));
      const variantButtons = Array.from(document.querySelectorAll(".variant-btn"));
      const failedFirstBtn = document.getElementById("failedFirstBtn");
      const expandAllBtn = document.getElementById("expandAllBtn");
      const collapseAllBtn = document.getElementById("collapseAllBtn");
      const suites = Array.from(document.querySelectorAll(".suite"));
      const testRows = Array.from(document.querySelectorAll(".test-row"));
      const detailsRows = Array.from(document.querySelectorAll(".detail-row"));
      const suiteToggles = Array.from(document.querySelectorAll("[data-suite-toggle]"));

      const allVariants = ["hcdark", "dark", "hclight", "light"];
      let activeFilter = "all";
      let activeVariants = new Set(allVariants);
      let failedFirst = false;
      const collapsedSuites = new Set();
      let hasManualCollapseState = false;

      function saveState() {
        try {
          localStorage.setItem(storageKey, JSON.stringify({
            search: searchInput?.value || "",
            activeFilter,
            activeVariants: Array.from(activeVariants),
            failedFirst,
            collapsedSuites: Array.from(collapsedSuites),
            hasManualCollapseState,
          }));
        } catch (_) {}
      }

      function loadState() {
        try {
          const raw = localStorage.getItem(storageKey);
          if (!raw) return;
          const state = JSON.parse(raw);
          if (typeof state.search === "string" && searchInput) searchInput.value = state.search;
          if (typeof state.activeFilter === "string") activeFilter = state.activeFilter;
          if (Array.isArray(state.activeVariants)) {
            const allowed = new Set(allVariants);
            const restored = state.activeVariants
              .map((value) => String(value))
              .filter((value) => allowed.has(value));
            if (restored.length > 0) activeVariants = new Set(restored);
          }
          if (typeof state.failedFirst === "boolean") failedFirst = state.failedFirst;
          if (Array.isArray(state.collapsedSuites)) {
            state.collapsedSuites.forEach((id) => collapsedSuites.add(String(id)));
          }
          if (typeof state.hasManualCollapseState === "boolean") {
            hasManualCollapseState = state.hasManualCollapseState;
          }
        } catch (_) {}
      }

      function rowMatchesFilter(row) {
        if (activeFilter === "all") return true;
        return (row.dataset.status || "") === activeFilter;
      }

      function rowMatchesSearch(row, query) {
        if (!query) return true;
        const title = normalizeTestTitle(row.dataset.title || row.dataset.test || "");
        return title.includes(query);
      }

      function inferVariant(testName) {
        const value = (testName || "").toLowerCase();
        if (value.includes("hclight") || value.includes("high-contrast-light")) return "hclight";
        if (value.includes("hcdark") || value.includes("high-contrast-dark")) return "hcdark";
        if (value.includes("_light") || value.endsWith("-light")) return "light";
        if (value.includes("_dark") || value.endsWith("-dark")) return "dark";
        return "other";
      }

      function rowMatchesVariant(row) {
        if (activeVariants.size === allVariants.length) return true;
        return activeVariants.has(inferVariant(row.dataset.test || ""));
      }

      function normalizeTestTitle(value) {
        return value
          .toLowerCase()
          .replace(/(_hclight|_hcdark|_light|_dark)$/i, "")
          .replace(/(-high-contrast-light|-high-contrast-dark|-light|-dark)$/i, "")
          .trim();
      }

      function applyFilters() {
        const query = (searchInput?.value || "").trim().toLowerCase();
        const filteringActive = (
          query.length > 0 ||
          activeFilter !== "all" ||
          activeVariants.size < allVariants.length
        );
        const visibleByKey = new Map();

        for (const row of testRows) {
          const key = row.dataset.key || "";
          const visible = rowMatchesFilter(row) && rowMatchesVariant(row) && rowMatchesSearch(row, query);
          visibleByKey.set(key, visible);
          row.classList.toggle("hidden-row", !visible);
        }

        for (const detailRow of detailsRows) {
          const parentKey = detailRow.dataset.parent || "";
          const parentVisible = visibleByKey.get(parentKey) === true;
          detailRow.classList.toggle("hidden-row", !parentVisible);
        }

        for (const suite of suites) {
          const rows = Array.from(suite.querySelectorAll(".test-row"));
          const hasVisible = rows.some((r) => !r.classList.contains("hidden-row"));
          suite.classList.toggle("hidden-row", !hasVisible);
        }

        for (const suite of suites) {
          if (suite.classList.contains("hidden-row")) continue;
          if (filteringActive) {
            setSuiteCollapsed(suite, false, false);
            continue;
          }
          if (hasManualCollapseState) {
            setSuiteCollapsed(suite, collapsedSuites.has(suite.id || ""), false);
            continue;
          }
          const hasFailure = Array.from(suite.querySelectorAll(".test-row"))
            .some((row) => row.dataset.status === "failed");
          setSuiteCollapsed(suite, !hasFailure, false);
        }
      }

      function applyFailedFirstSorting() {
        for (const suite of suites) {
          const tbody = suite.querySelector("tbody");
          if (!tbody) continue;
          const rows = Array.from(tbody.querySelectorAll(":scope > tr"));
          const groups = [];

          for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            if (!row.classList.contains("test-row")) continue;
            const key = row.dataset.key || "";
            const group = [row];
            for (let j = i + 1; j < rows.length; j++) {
              const next = rows[j];
              if (next.classList.contains("test-row")) break;
              if (next.classList.contains("detail-row") && next.dataset.parent === key) {
                group.push(next);
              }
            }
            groups.push(group);
          }

          groups.sort((a, b) => {
            const sa = a[0].dataset.status || "";
            const sb = b[0].dataset.status || "";
            if (sa === sb) return 0;
            if (sa === "failed") return -1;
            if (sb === "failed") return 1;
            if (sa === "skipped") return 1;
            if (sb === "skipped") return -1;
            return 0;
          });

          for (const group of groups) {
            for (const row of group) tbody.appendChild(row);
          }
        }
      }

      function setSuiteCollapsed(suite, collapsed, persist = true) {
        suite.classList.toggle("suite-collapsed", collapsed);
        const btn = suite.querySelector("[data-suite-toggle]");
        if (btn) btn.textContent = collapsed ? "Expand" : "Collapse";
        if (!persist) return;
        hasManualCollapseState = true;
        const suiteId = suite.id || "";
        if (suiteId) {
          if (collapsed) collapsedSuites.add(suiteId);
          else collapsedSuites.delete(suiteId);
        }
      }

      filterButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          activeFilter = btn.dataset.filter || "all";
          filterButtons.forEach((b) => b.classList.toggle("active", b === btn));
          applyFilters();
          saveState();
        });
      });

      variantButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const variant = btn.dataset.variant || "";
          if (!allVariants.includes(variant)) return;
          if (activeVariants.has(variant)) {
            if (activeVariants.size === 1) return;
            activeVariants.delete(variant);
          } else {
            activeVariants.add(variant);
          }
          variantButtons.forEach((b) => b.classList.toggle("active", activeVariants.has(b.dataset.variant || "")));
          applyFilters();
          saveState();
        });
      });

      searchInput?.addEventListener("input", () => {
        applyFilters();
        saveState();
      });

      failedFirstBtn?.addEventListener("click", () => {
        failedFirst = !failedFirst;
        failedFirstBtn.textContent = `Failed First: ${failedFirst ? "On" : "Off"}`;
        if (failedFirst) {
          applyFailedFirstSorting();
          applyFilters();
        }
        saveState();
      });

      expandAllBtn?.addEventListener("click", () => {
        suites.forEach((suite) => setSuiteCollapsed(suite, false, true));
        saveState();
      });

      collapseAllBtn?.addEventListener("click", () => {
        suites.forEach((suite) => {
          const hasFailure = Array.from(suite.querySelectorAll(".test-row"))
            .some((row) => row.dataset.status === "failed");
          setSuiteCollapsed(suite, !hasFailure, true);
        });
        saveState();
      });

      suiteToggles.forEach((btn) => {
        btn.addEventListener("click", () => {
          const suite = btn.closest(".suite");
          if (!suite) return;
          setSuiteCollapsed(suite, !suite.classList.contains("suite-collapsed"), true);
          saveState();
        });
      });

      document.addEventListener("keydown", (event) => {
        const target = event.target;
        const isTypingField = target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement;
        if (event.key === "/" && !isTypingField) {
          event.preventDefault();
          searchInput?.focus();
          searchInput?.select();
          return;
        }
        if (event.key.toLowerCase() === "f" && !isTypingField) {
          event.preventDefault();
          const failedFilterButton = filterButtons.find((btn) => (btn.dataset.filter || "") === "failed");
          failedFilterButton?.click();
          return;
        }
        if (event.key.toLowerCase() === "e" && !isTypingField) {
          event.preventDefault();
          const anyCollapsed = suites.some((suite) => suite.classList.contains("suite-collapsed"));
          if (anyCollapsed) expandAllBtn?.click();
          else collapseAllBtn?.click();
        }
      });

      loadState();
      filterButtons.forEach((btn) => {
        btn.classList.toggle("active", (btn.dataset.filter || "all") === activeFilter);
      });
      variantButtons.forEach((btn) => {
        btn.classList.toggle("active", activeVariants.has(btn.dataset.variant || ""));
      });
      failedFirstBtn.textContent = `Failed First: ${failedFirst ? "On" : "Off"}`;
      if (failedFirst) applyFailedFirstSorting();
      applyFilters();
      if (!hasManualCollapseState) {
        collapseAllBtn?.click();
      }
    })();
  </script>
</body>
</html>
